<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Traveloka Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
          rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&amp;display=swap"
          rel="stylesheet" />
    <style>
        body {
            font-family: "Inter", sans-serif;
        }
    </style>
</head>
<body class="bg-white text-gray-900">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-6">
                    <a class="flex items-center space-x-2 cursor-pointer"
                       id="logo-button"
                       role="button"
                       tabindex="0"
                       aria-label="Toggle mobile menu"
                       href="/Home">
                        <!-- Logo Image -->
                        <img src="/images/logo.png" alt="VieGo Logo" style="height: 120px; width: 120px;" />

                    </a>
                    <ul class="hidden md:flex space-x-6 text-sm font-normal text-[#1a1a1a]">
                        <li>
                            <a class="hover:underline" href="aboutus.html"> About Us </a>
                        </li>
                        <li>
                            <a class="hover:underline" href="faq.html"> FAQs </a>
                        </li>
                        <li>
                            <a class="hover:underline" href="blog.html"> Blog </a>
                        </li>
                        <li>
                            <a class="hover:underline" href="/MyBooking">
                                My Bookings
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
    </header>
    <!-- Main content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 mb-16">
        <h1 class="text-lg font-semibold text-gray-900 mb-1 select-none">
            Complete Your Booking
        </h1>
        <div class="flex flex-col lg:flex-row lg:space-x-8">
            <!-- Left form side -->
            <section class="flex-1 space-y-6">
                <!-- Contact info -->
                <div class="bg-gray-50 rounded-md p-6">
                    <h2 class="flex items-center text-gray-900 font-semibold mb-4 select-none">
                        <i class="fas fa-user-friends text-pink-500 mr-2"> </i>
                        Thông tin liên hệ
                    </h2>
                    <form class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-xs text-gray-700">
                        <div class="flex flex-col">
                            <label class="mb-1 font-semibold select-none" for="fullname">
                                Họ tên
                                <span class="text-pink-600"> * </span>
                            </label>
                            <input class="border border-gray-300 rounded px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-pink-500"
                                   id="fullname"
                                   placeholder="Nhập họ tên"
                                   type="text" />
                        </div>
                        <div class="flex flex-col">
                            <label class="mb-1 font-semibold select-none" for="email">
                                Email
                                <span class="text-pink-600"> * </span>
                            </label>
                            <input class="border border-gray-300 rounded px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-pink-500"
                                   id="email"
                                   placeholder="Email"
                                   type="email" />
                        </div>
                        <div class="flex flex-col">
                            <label class="mb-1 font-semibold select-none" for="phone">
                                Số điện thoại
                                <span class="text-pink-600"> * </span>
                            </label>
                            <input class="border border-gray-300 rounded px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-pink-500"
                                   id="phone"
                                   placeholder="Số điện thoại"
                                   type="tel" />
                        </div>
                        <div class="flex flex-col">
                            <label class="mb-1 font-semibold select-none" for="address">
                                Địa chỉ
                            </label>
                            <input class="border border-gray-300 rounded px-3 py-2 text-xs placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-pink-500"
                                   id="address"
                                   placeholder="Địa chỉ"
                                   type="text" />
                        </div>
                    </form>
                </div>
                <!-- Passenger info -->
                <div class="bg-gray-50 rounded-md p-6">
                    <h2 class="flex items-center text-gray-900 font-semibold mb-4 select-none">
                        <i class="fas fa-id-card-alt text-pink-500 mr-2"> </i>
                        Thông tin hành khách
                    </h2>
                    <form class="space-y-3 text-xs text-gray-700">
                        <div>
                            <label class="font-semibold select-none" for="adult">
                                Số lượng
                            </label>
                            <span class="ml-2 border border-gray-300 rounded px-2 py-1 text-xs text-gray-700 focus:outline-none focus:ring-1 focus:ring-pink-500" id="adult"> 2</span>
                        </div>
                        <div>
                            <label class="block mb-1 select-none" for="special">
                                Yêu cầu đặc biệt
                            </label>
                            <textarea class="w-full border border-gray-300 rounded px-3 py-2 text-xs placeholder:text-gray-400 resize-none focus:outline-none focus:ring-1 focus:ring-pink-500"
                                      id="special"
                                      placeholder="Vui lòng cho chúng tôi biết nếu bạn có yêu cầu đặc biệt (ví dụ: thực đơn đặc biệt, hỗ trợ đặc biệt...)"
                                      rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <!-- Discount code -->
                <!--<div class="bg-gray-50 rounded-md p-6">
                    <h2 class="flex items-center text-gray-900 font-semibold mb-4 select-none">
                        <i class="fas fa-ticket-alt text-pink-500 mr-2"> </i>
                        Mã giảm giá
                    </h2>
                    <form class="flex items-center space-x-3 text-xs text-gray-700">
                        <label class="w-24 select-none" for="discount">
                            Discount Code
                        </label>
                        <input class="flex-1 border border-gray-300 rounded px-3 py-2 placeholder:text-gray-400 focus:outline-none focus:ring-1 focus:ring-pink-500"
                               id="discount"
                               placeholder="Enter discount code"
                               type="text" />
                        <button class="bg-pink-600 text-white px-4 py-2 rounded text-xs font-semibold hover:bg-pink-700 select-none"
                                type="button">
                            Apply
                        </button>
                    </form>
                </div>-->
                <!-- Payment method -->
                <!--<div class="bg-gray-50 rounded-md p-6">
                    <h2 class="flex items-center text-gray-900 font-semibold mb-4 select-none">
                        <i class="fas fa-credit-card text-pink-500 mr-2"> </i>
                        Phương thức thanh toán
                    </h2>
                    <form class="space-y-4 text-xs text-gray-700">
                        <label class="flex items-start space-x-3 cursor-pointer select-none"
                               for="pay1">
                            <input checked=""
                                   class="mt-1 text-pink-600 focus:ring-pink-500"
                                   id="pay1"
                                   name="payment"
                                   type="radio" />
                            <div>
                                <div class="font-semibold text-gray-900">
                                    Thanh toán tại quầy Du Lịch Việt
                                </div>
                                <div class="text-gray-400">
                                    Thanh toán trực tiếp tại văn phòng
                                </div>
                            </div>
                        </label>
                        <label class="flex items-start space-x-3 cursor-pointer select-none"
                               for="pay2">
                            <input class="mt-1 text-pink-600 focus:ring-pink-500"
                                   id="pay2"
                                   name="payment"
                                   type="radio" />
                            <div>
                                <div class="font-semibold text-gray-900">
                                    Thanh toán chuyển khoản qua ngân hàng
                                </div>
                                <div class="text-gray-400">
                                    Chuyển khoản đến tài khoản của Du Lịch Việt
                                </div>
                            </div>
                        </label>
                        <label class="flex items-center justify-between cursor-pointer select-none"
                               for="pay3">
                            <div class="flex items-start space-x-3">
                                <input class="mt-1 text-pink-600 focus:ring-pink-500"
                                       id="pay3"
                                       name="payment"
                                       type="radio" />
                                <div class="font-semibold text-gray-900">
                                    Thanh toán qua ZaloPay
                                </div>
                            </div>
                            <div class="w-8 h-8 bg-gray-200 rounded flex items-center justify-center text-gray-400 font-semibold select-none">
                                E
                            </div>
                        </label>
                        <label class="flex items-center justify-between cursor-pointer select-none"
                               for="pay4">
                            <div class="flex items-start space-x-3">
                                <input class="mt-1 text-pink-600 focus:ring-pink-500"
                                       id="pay4"
                                       name="payment"
                                       type="radio" />
                                <div class="font-semibold text-gray-900">
                                    Thanh toán qua MoMo
                                </div>
                            </div>
                            <div class="w-8 h-8 bg-gray-200 rounded flex items-center justify-center text-gray-400 font-semibold select-none">
                                E
                            </div>
                        </label>
                        <label class="flex items-center justify-between cursor-pointer select-none"
                               for="pay5">
                            <div class="flex items-start space-x-3">
                                <input class="mt-1 text-pink-600 focus:ring-pink-500"
                                       id="pay5"
                                       name="payment"
                                       type="radio" />
                                <div class="font-semibold text-gray-900">
                                    Thanh toán qua VNPAY
                                </div>
                            </div>
                            <div class="w-8 h-8 bg-gray-200 rounded flex items-center justify-center text-gray-400 font-semibold select-none">
                                E
                            </div>
                        </label>
                    </form>
                </div>
                <div class="text-xs text-gray-700 flex items-center space-x-2 select-none">
                    <input class="w-4 h-4 border border-gray-300 rounded text-pink-600 focus:ring-pink-500"
                           id="agree"
                           type="checkbox" />
                    <label class="cursor-pointer" for="agree">
                        Bằng việc tiếp tục, bạn chấp nhận đồng ý với chính sách/điều khoản
                        như trên.
                    </label>
                </div>
                <button class="w-full bg-pink-600 hover:bg-pink-700 text-white font-semibold text-sm py-2 rounded mt-4 select-none"
                        type="submit">
                    Hoàn thành
                </button>-->
            </section>
            <!-- Right summary side -->
            <aside class="w-full lg:w-80 bg-gray-50 rounded-md p-6 mt-8 lg:mt-0 text-xs text-gray-700 select-none">
                <h3 class="font-semibold text-gray-900 mb-4">
                    Lịch trình và giá tour
                </h3>
                <div class="mb-4 space-y-2">
                    <div>
                        <div class="font-semibold text-gray-900">Tên tour</div>
                        <div id="tourName">Bali 4D3N: Explore Paradise Island</div>
                    </div>
                    <div class="flex justify-between">
                        <div>
                            <div class="font-semibold text-gray-900">Ngày khởi hành</div>
                            <div id="startDate">Flexible</div>
                        </div>
                        <div>
                            <div class="font-semibold text-gray-900">Ngày kết thúc</div>
                            <div id="endDate">Flexible</div>
                        </div>
                    </div>
                    <div>
                        <div class="font-semibold text-gray-900">Số chỗ còn nhận</div>
                        <div id="slots">10</div>
                    </div>
                </div>
                <div>
                    <label class="block mb-1 font-semibold text-gray-900"
                           for="discount-code">
                        Discount Code
                    </label>
                    <div class="flex space-x-2">
                        <input class="flex-grow border border-gray-300 rounded px-3 py-2 text-xs text-gray-700"
                               id="discount-code"
                               name="discount-code"
                               placeholder="Enter discount code"
                               type="text" />
                        <button class="bg-pink-600 text-white px-3 py-2 rounded text-xs font-semibold hover:bg-pink-700"
                                type="submit"
                                onclick="applyDiscount()">
                            Apply
                        </button>
                    </div>
                    <p id="discount-message" class="mt-2 text-sm font-medium"></p>
                </div>
                <!--<h4 class="font-semibold text-gray-900 mb-3">
        Bảng giá tour chi tiết
    </h4>
    <div class="mb-4 space-y-1">
        <div class="flex justify-between">
            <div>Người lớn (từ 12 tuổi)</div>
            <div>$250</div>
        </div>
        <div class="flex justify-between">
            <div>Trẻ em (2 - 11 tuổi)</div>
            <div>$187.5</div>
        </div>
    </div>-->
                <div class="border-t border-gray-300 pt-3 space-y-2 font-semibold text-gray-900">
                    <div class="flex justify-between">
                        <div>Số lượng (2 x $250)</div>
                        <div>$500</div>
                    </div>
                    <div class="flex justify-between">
                        <div>Tổng tiền</div>
                        <div id="amount">$500</div>
                    </div>
                    <div class="flex justify-between">
                        <p>Khuyến mãi</p>
                        <p id="discount-amount">0 ₫</p>
                    </div>
                    <div class="flex justify-between">
                        <div>Thành tiền</div>
                        <div>$500</div>
                    </div>
                </div>
                <div id="tour-info"></div>
                <input type="hidden" id="RequestVerificationToken" name="__RequestVerificationToken" value="@Antiforgery.GetAndStoreTokens(HttpContext).RequestToken" />
                <button id="payPayOSBtn" type="button"
                        class="mt-4 w-full bg-pink-600 hover:bg-pink-700 text-white font-semibold text-sm py-2 rounded select-none">
                    Pay with PayOS
                </button>
            </aside>
        </div>
    </main>
    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-300 text-xs select-none">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 grid grid-cols-2 md:grid-cols-4 gap-8">
            <div>
                <h5 class="font-semibold text-gray-100 mb-3">About</h5>
                <ul class="space-y-1">
                    <li>
                        <a class="hover:underline" href="#"> How it works </a>
                    </li>
                    <li>
                        <a class="hover:underline" href="#"> About us </a>
                    </li>
                    <li>
                        <a class="hover:underline" href="#"> Careers </a>
                    </li>
                    <li>
                        <a class="hover:underline" href="#"> Press </a>
                    </li>
                </ul>
            </div>
            <div>
                <h5 class="font-semibold text-gray-100 mb-3">Support</h5>
                <ul class="space-y-1">
                    <li>
                        <a class="hover:underline" href="#"> Help Center </a>
                    </li>
                    <li>
                        <a class="hover:underline" href="#"> Contact us </a>
                    </li>
                    <li>
                        <a class="hover:underline" href="#"> Privacy policy </a>
                    </li>
                    <li>
                        <a class="hover:underline" href="#"> Terms of service </a>
                    </li>
                </ul>
            </div>
            <div>
                <h5 class="font-semibold text-gray-100 mb-3">Products</h5>
                <ul class="space-y-1">
                    <li>
                        <a class="hover:underline" href="#"> Flights </a>
                    </li>
                    <li>
                        <a class="hover:underline" href="#"> Hotels </a>
                    </li>
                    <li>
                        <a class="hover:underline" href="#"> Train tickets </a>
                    </li>
                    <li>
                        <a class="hover:underline" href="#"> Activities </a>
                    </li>
                </ul>
            </div>
            <div>
                <h5 class="font-semibold text-gray-100 mb-3">Follow Us</h5>
                <div class="flex space-x-3 mb-3 text-gray-300">
                    <a aria-label="Facebook" class="hover:text-white" href="#">
                        <i class="fab fa-facebook-f"> </i>
                    </a>
                    <a aria-label="Instagram" class="hover:text-white" href="#">
                        <i class="fab fa-instagram"> </i>
                    </a>
                    <a aria-label="Twitter" class="hover:text-white" href="#">
                        <i class="fab fa-twitter"> </i>
                    </a>
                    <a aria-label="LinkedIn" class="hover:text-white" href="#">
                        <i class="fab fa-linkedin-in"> </i>
                    </a>
                </div>
                <div class="text-gray-900 bg-white rounded px-2 py-1 text-[9px] font-semibold flex space-x-1 w-max">
                    <span> Visa </span>
                    <span> MC </span>
                    <span> Amex </span>
                    <span> PayPal </span>
                </div>
            </div>
        </div>
        <div class="border-t border-gray-800 text-gray-500 text-center py-4 text-[10px]">
            © 2023 Traveloka Clone. All rights reserved.
        </div>
    </footer>

    <script>
        const params = new URLSearchParams(window.location.search);
        const tourId = params.get('tourId');
        const quantity = params.get('quantity');
        let price = parseInt(params.get('price')); // Make price mutable for discount
        const baseUrl = `${window.location.protocol}//${window.location.host}`;
        const API_URL = `${baseUrl}/api/Booking/GetBooking/${tourId}?quantity=${quantity}&price=${price}`;

        // Store the original price, discounted price, and discount amount
        let originalPrice = price;
        let discountedPrice = price;
        let discountAmount = 0;

        async function fetchData() {
            try {
                if (!tourId) throw new Error('Tour ID not found in URL.');

                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = `${baseUrl}/Login/Index`;
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Booking data:', data);

                // === Contact info ===
                const contact = data.contactInfo || {};
                document.getElementById("fullname").value = contact.fullName || '';
                document.getElementById("email").value = contact.email || '';
                document.getElementById("phone").value = contact.phoneNumber || '';
                document.getElementById("address").value = contact.address || '';

                // === Number of adults ===
                const passengerInfo = data.passengerInfo || {};
                const quantityFromData = passengerInfo.quantity || quantity || 1; // fallback

                if (document.getElementById("adult")) {
                    document.getElementById("adult").textContent = quantityFromData;
                }

                // === Tour info ===
                const tour = data.tourInfo || {};
                if (document.getElementById("tourName")) {
                    document.getElementById("tourName").textContent = tour.name || 'N/A';
                }
                if (document.getElementById("startDate")) {
                    document.getElementById("startDate").textContent = tour.startDate || 'N/A';
                }
                if (document.getElementById("endDate")) {
                    document.getElementById("endDate").textContent = tour.endDate || 'N/A';
                }
                if (document.getElementById("slots")) {
                    document.getElementById("slots").textContent = tour.availableSeats ?? 'N/A';
                }

                // === Price ===
                // price từ URL có thể dùng fallback nếu data không có giá trị rõ ràng
                // TourInfo.price đang ở dạng string '7.200.000 ₫' => cần convert sang số để tính toán
                const priceString = tour.price || '0 ₫';
                originalPrice = parsePriceString(priceString); // chuyển '7.200.000 ₫' -> 7200000
                discountedPrice = originalPrice;  // Bạn chưa có discount info nên tạm bằng nhau
                discountAmount = 0;

                updatePriceDisplay(quantityFromData);

            } catch (error) {
                console.error('Error fetching booking data:', error);
            }
        }

        // Hàm hỗ trợ chuyển chuỗi tiền '7.200.000 ₫' thành số 7200000
        function parsePriceString(priceStr) {
            if (!priceStr) return 0;
            // Loại bỏ ký tự không phải số, ví dụ dấu chấm và khoảng trắng, đồng thời xóa ký hiệu ₫
            const cleaned = priceStr.replace(/[.\s₫]/g, '');
            return parseInt(cleaned) || 0;
        }

        function updatePriceDisplay(quantityNum = 1) {
            const unitPrice = Math.floor(originalPrice / quantityNum);
            const totalOriginal = originalPrice.toLocaleString("vi-VN") + " ₫";
            const discount = discountAmount > 0 ? discountAmount.toLocaleString("vi-VN") + " ₫" : "0 ₫";
            const finalPrice = discountedPrice.toLocaleString("vi-VN") + " ₫";

            const priceRows = document.querySelectorAll("aside .border-t > div");
            priceRows.forEach(row => {
                if (row.children.length < 2) return;

                if (row.textContent.includes("Số lượng")) {
                    row.children[0].textContent = `Số lượng (${quantityNum} x ${unitPrice.toLocaleString("vi-VN")}₫)`;
                    row.children[1].textContent = totalOriginal;
                }
                if (row.textContent.includes("Tổng tiền")) {
                    row.children[1].textContent = totalOriginal;
                }
                if (row.textContent.includes("Khuyến mãi")) {
                    row.children[1].textContent = discount;
                    row.children[1].classList.add("text-green-600");
                }
                if (row.textContent.includes("Thành tiền")) {
                    row.children[1].textContent = finalPrice;
                }
            });
        }

        // Gọi hàm fetchData khi trang load xong
        fetchData();

        // Discount application function
        async function applyDiscount() {
            const discountInput = document.getElementById('discount-code');
            const discountMessage = document.getElementById('discount-message');

            const code = discountInput.value.trim();
            if (!code) {
                discountMessage.textContent = 'Please enter a discount code.';
                discountMessage.classList.add('text-red-500');
                return;
            }

            try {
                const response = await fetch(`https://localhost:5001/api/DiscountCodeApi/validate?code=${encodeURIComponent(code)}`);
                const data = await response.json();

                if (data.valid) {
                    const percentage = data.percentage;
                    discountMessage.textContent = `Discount applied: ${percentage}% off!`;
                    discountMessage.classList.remove('text-red-500');
                    discountMessage.classList.add('text-green-500');

                    // Calculate discount amount and new total price
                    discountAmount = (originalPrice * percentage) / 100;
                    discountedPrice = originalPrice - discountAmount;

                    // Update the displayed price
                    updatePriceDisplay();
                } else {
                    discountMessage.textContent = 'Invalid or expired discount code.';
                    discountMessage.classList.add('text-red-500');
                    discountedPrice = originalPrice; // Reset to original price
                    discountAmount = 0; // Reset discount amount
                    updatePriceDisplay();
                }
            } catch (error) {
                console.error('Error validating discount code:', error);
                discountMessage.textContent = 'Error applying discount. Please try again.';
                discountMessage.classList.add('text-red-500');
                discountedPrice = originalPrice; // Reset to original price
                discountAmount = 0; // Reset discount amount
                updatePriceDisplay();
            }
        }

        async function payWithPayOS(fullName, amount, orderInfor, tourId) {
            const orderCode = Math.floor(Math.random() * 1000000000);
            const cancelUrl = "https://localhost:5001/payment/payment-cancel.html";
            const returnUrl = `https://localhost:5001/payment/payment-success.html?orderCode=${orderCode}&amount=${amount}&tourId=${tourId}&people=${quantity}`;
            const description = orderInfor;

            const dataToSign = `amount=${amount}&cancelUrl=${cancelUrl}&description=${description}&orderCode=${orderCode}&returnUrl=${returnUrl}`;

            const encoder = new TextEncoder();
            const keyData = encoder.encode("06121708cb7de81ce9fc011cb9f3880eb222e70ddd0750fa843654e2ac468809");
            const key = await crypto.subtle.importKey(
                "raw",
                keyData,
                { name: "HMAC", hash: "SHA-256" },
                false,
                ["sign"]
            );
            const signatureBuffer = await crypto.subtle.sign("HMAC", key, encoder.encode(dataToSign));
            const signatureArray = Array.from(new Uint8Array(signatureBuffer));
            const signature = signatureArray.map(b => b.toString(16).padStart(2, '0')).join('');

            const orderInfo = {
                orderCode: orderCode,
                amount: amount,
                description: description,
                buyerName: fullName,
                returnUrl: returnUrl,
                cancelUrl: cancelUrl,
                signature: signature
            };

            try {
                const response = await fetch(`${baseUrl}/api/Payment/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderInfo)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                const data = await response.json();

                if (data?.checkoutUrl) {
                    window.location.href = data.checkoutUrl;
                } else {
                    throw new Error('Invalid checkout URL from server.');
                }
            } catch (error) {
                alert('Error initiating payment with PayOS: ' + error.message);
            }
        }

        const payBtn = document.getElementById('payPayOSBtn');

        function validateForm() {
            if (payBtn) {
                payBtn.disabled = true;
            } else {
                console.error('Element #payPayOSBtn not found in validateForm');
            }
            const adultsCount = parseInt(quantity);
            const availableSeats = parseInt(document.getElementById('slots')?.textContent) || 0;

            const isValid = adultsCount > 0 && adultsCount <= availableSeats;

            payBtn.disabled = !isValid;
            payBtn.style.backgroundColor = isValid ? '' : 'gray';
            payBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';

            return isValid;
        }

        function validateContactForm() {
            const fields = ['fullname', 'email', 'phone'];
            let isValid = true;

            document.querySelectorAll('.error-msg').forEach(el => el.remove());

            fields.forEach(fieldId => {
                const input = document.getElementById(fieldId);
                if (input.value.trim() === '') {
                    isValid = false;
                    const error = document.createElement('span');
                    error.className = 'error-msg text-pink-600 text-xs mt-1';
                    error.textContent = 'Vui lòng nhập trường này';
                    input.parentElement.appendChild(error);
                }
            });

            return isValid;
        }

        if (payBtn) {
            payBtn.addEventListener('click', (e) => {
                e.preventDefault();

                const isContactValid = validateContactForm();
                const isSlotValid = validateForm();

                if (!isContactValid || !isSlotValid) {
                    return;
                }

                const fullNameInput = document.getElementById("fullname");
                const fullName = fullNameInput ? fullNameInput.value : '';

                const amount = discountedPrice; // Use discounted price for payment
                const tourNameElem = document.getElementById("tourName");
                const tourName = tourNameElem ? tourNameElem.textContent : '';

                const orderInfor = `Đặt tour ${tourName}`;
                let shortDescription = orderInfor.substring(0, 25);

                payWithPayOS(fullName, amount, shortDescription, parseInt(tourId, 10) || 0);
            });
        } else {
            console.error('Element #payPayOSBtn not found');
        }

        // Add event listener for the Apply button
        const applyDiscountBtn = document.querySelector('button[onclick="applyDiscount()"]');
        if (applyDiscountBtn) {
            applyDiscountBtn.addEventListener('click', applyDiscount);
        }

        document.addEventListener('DOMContentLoaded', fetchData);

    </script>
</body>
</html>
