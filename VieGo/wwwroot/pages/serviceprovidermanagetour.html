<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VieGo Manage Tours</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
          rel="stylesheet" />
    <style>
        body {
            font-family: "Inter", sans-serif;
        }
        /* Custom scrollbar for textarea vertical scroll */
        textarea::-webkit-scrollbar {
            width: 8px;
        }

        textarea::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* Tailwind slate-300 */
            border-radius: 4px;
        }

        .tab-content {
            display: none;
        }

            .tab-content.active {
                display: block;
            }
        /* Image upload styles */
        .image-upload-container {
            border: 2px dashed #cbd5e1;
            border-radius: 0.375rem;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

            .image-upload-container:hover {
                border-color: #94a3b8;
                background-color: #f8fafc;
            }

        .image-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 0.375rem;
            margin-top: 0.5rem;
            display: none;
        }

        .image-preview-container {
            position: relative;
            margin-top: 0.5rem;
        }

        .remove-image {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

            .remove-image:hover {
                background-color: rgba(255, 255, 255, 1);
            }
    </style>
</head>
<body class="bg-white text-gray-900">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-6">
                    <a class="flex items-center space-x-2 cursor-pointer"
                       id="logo-button"
                       role="button"
                       tabindex="0"
                       aria-label="Toggle mobile menu"
                       href="/Home">
                        <!-- Logo Image -->
                        <img src="/images/logo.png" alt="VieGo Logo" style="height: 120px; width: 120px;" />

                    </a>
                    <ul class="hidden md:flex space-x-6 text-sm font-normal text-[#1a1a1a]">
                        <li>
                            <a class="hover:underline" href="aboutus.html"> About Us </a>
                        </li>
                        <li>
                            <a class="hover:underline" href="faq.html"> FAQs </a>
                        </li>
                        <li>
                            <a class="hover:underline" href="blog.html"> Blog </a>
                        </li>
                        <li>
                            <a class="hover:underline" href="/MyBooking">
                                My Bookings
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
    </header>

    <main class="flex min-h-[calc(100vh-56px)]">
        <!-- Sidebar -->
        <aside class="w-56 border-r border-gray-200 px-4 py-6 text-sm font-semibold text-gray-900 select-none overflow-y-auto">
            <h2 class="mb-4">Service Provider</h2>
            <nav class="flex flex-col space-y-2 text-gray-700 font-normal">
                <a class="flex items-center space-x-2 hover:text-gray-900 transition-colors duration-200"
                   href="serviceproviderdashboard.html"><i class="fas fa-list-alt text-xs"></i><span>Dashboard</span></a>
                <a class="flex items-center space-x-2 hover:text-gray-900 transition-colors duration-200"
                   href="serviceprovidermanagetour.html"><i class="fas fa-list-alt text-xs"></i><span>Manage Tours</span></a>
                <a class="flex items-center space-x-2 hover:text-gray-900 transition-colors duration-200"
                   href="serviceProvidermanagevoucher.html">
                    <i class="fas fa-ticket-alt text-xs"></i><span>Manage Vouchers</span>
                </a>
                <a class="flex items-center space-x-2 hover:text-gray-900 transition-colors duration-200"
                   href="serviceProvidervoucherusage.html">
                    <i class="fas fa-chart-pie text-xs"></i><span>Voucher Usage</span>
                </a>
                <a class="flex items-center space-x-2 hover:text-gray-900 transition-colors duration-200"
                   href="serviceprovidermanagebookings.html">
                    <i class="fas fa-calendar-check text-xs"></i><span>Manage Bookings</span>
                </a>
                <a class="flex items-center space-x-2 hover:text-gray-900 transition-colors duration-200"
                   href="#">
                    <i class="fas fa-comment-alt text-xs"></i><span>Customer Reviews</span>
                </a>
                <a class="flex items-center space-x-2 hover:text-gray-900 transition-colors duration-200"
                   href="#">
                    <i class="far fa-star text-xs"></i><span>Rating Statistics</span>
                </a>
            </nav>
        </aside>

        <!-- Content -->
        <section class="flex-1 p-6">
            <h1 class="text-lg font-extrabold mb-1 select-none">Tours</h1>
            <p class="text-sm text-gray-500 mb-6 select-none">
                Create and manage your tour offerings
            </p>

            <!-- API Test Section (for debugging) -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-6">
                <h3 class="font-semibold text-sm mb-2">API Connection Test</h3>
                <div class="flex space-x-2 mb-2">
                    <button id="testApiBtn" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                        Test API
                    </button>
                    <button id="testDbBtn" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                        Test Database
                    </button>
                </div>
                <div id="apiTestResult" class="text-xs bg-white p-2 rounded border min-h-[60px] font-mono"></div>
            </div>

            <div class="bg-white border border-gray-200 rounded-md p-6">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                    <div>
                        <h2 class="font-semibold text-base select-none">Your Tours</h2>
                        <p id="tourCount" class="text-xs text-gray-500 select-none">
                            You have 0 tours in total
                        </p>
                    </div>
                    <button id="createTourBtn"
                            class="mt-3 sm:mt-0 inline-flex items-center space-x-2 bg-gray-900 text-white text-xs font-semibold px-4 py-2 rounded-md hover:bg-gray-800"
                            type="button">
                        <i class="fas fa-plus text-[10px]"></i>
                        <span>Create Tour</span>
                    </button>
                </div>

                <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-2 mb-4 relative">
                    <input type="text"
                           id="searchInput"
                           placeholder="Search tours..."
                           class="flex-1 border border-gray-300 rounded-md px-3 py-2 text-xs text-gray-700 focus:outline-none focus:ring-1 focus:ring-gray-400" />
                    <div class="relative mt-2 sm:mt-0">
                        <button id="filterBtn"
                                aria-haspopup="true"
                                aria-expanded="false"
                                class="flex items-center space-x-1 border border-gray-300 rounded-md px-3 py-2 text-xs text-gray-700 hover:bg-gray-100 focus:outline-none"
                                type="button">
                            <span>Filter</span>
                            <i class="fas fa-sort text-[10px]"></i>
                        </button>
                        <!-- Dropdown -->
                        <div id="filterDropdown"
                             class="hidden absolute right-0 mt-1 w-32 bg-white border border-gray-300 rounded-md shadow-lg z-10"
                             role="menu"
                             aria-label="Filter tours by status">
                            <button class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-100 focus:bg-gray-100 focus:outline-none"
                                    type="button"
                                    data-status="all">
                                All
                            </button>
                            <button class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-100 focus:bg-gray-100 focus:outline-none"
                                    type="button"
                                    data-status="Active">
                                Active
                            </button>
                            <button class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-100 focus:bg-gray-100 focus:outline-none"
                                    type="button"
                                    data-status="Inactive">
                                Inactive
                            </button>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto overflow-visible relative">
                    <table class="w-full text-xs text-left text-gray-700 border-collapse border border-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="border border-gray-200 px-3 py-2 font-normal">
                                    Tour Code
                                </th>
                                <th class="border border-gray-200 px-3 py-2 font-normal">
                                    Name
                                </th>
                                <th class="border border-gray-200 px-3 py-2 font-normal">
                                    Departure From
                                </th>
                                <th class="border border-gray-200 px-3 py-2 font-normal">
                                    Destination
                                </th>
                                <th class="border border-gray-200 px-3 py-2 font-normal">
                                    Duration
                                </th>
                                <th class="border border-gray-200 px-3 py-2 font-normal">
                                    Status
                                </th>
                                <th class="border border-gray-200 px-3 py-2 font-normal">
                                    Type
                                </th>
                                <th class="border border-gray-200 px-3 py-2 font-normal">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tourTableBody">
                            <!-- Tours will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal backdrop -->
    <div id="modalBackdrop"
         class="fixed inset-0 bg-black bg-opacity-30 hidden z-30"
         aria-hidden="true"></div>

    <!-- Create Tour Modal -->
    <div id="createTourModal"
         class="fixed inset-0 flex items-center justify-center p-4 hidden z-40"
         role="dialog"
         aria-modal="true"
         aria-labelledby="modalTitle">
        <div class="bg-white rounded-md shadow-lg max-w-md w-full p-6 relative">
            <h2 id="modalTitle" class="text-lg font-semibold mb-4 select-none">
                Create Tour
            </h2>
            <form id="tourForm" class="space-y-4 text-xs text-gray-700">
                <div>
                    <label for="tourCode" class="block mb-1 font-semibold select-none">Tour Code</label>
                    <input type="text"
                           id="tourCode"
                           name="tourCode"
                           required
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                           placeholder="Enter tour code" />
                </div>
                <div>
                    <label for="tourName"
                           class="block mb-1 font-semibold select-none">Tour Name</label>
                    <input type="text"
                           id="tourName"
                           name="tourName"
                           required
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                           placeholder="Enter tour name" />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="departureCity"
                               class="block mb-1 font-semibold select-none">Departure City</label>
                        <input type="text"
                               id="departureCity"
                               name="departureCity"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                               placeholder="Enter departure city" />
                    </div>
                    <div>
                        <label for="destination" class="block mb-1 font-semibold select-none">Destination</label>
                        <input type="text"
                               id="destination"
                               name="destination"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                               placeholder="Enter destination" />
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label for="duration" class="block mb-1 font-semibold select-none">Duration</label>
                        <input type="text"
                               id="duration"
                               name="duration"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                               placeholder="e.g. 3 days 2 nights" />
                    </div>
                    <div>
                        <label for="groupSizeMin" class="block mb-1 font-semibold select-none">Min Group Size</label>
                        <input type="number"
                               id="groupSizeMin"
                               name="groupSizeMin"
                               min="1"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                               placeholder="Min size" />
                    </div>
                    <div>
                        <label for="groupSizeMax" class="block mb-1 font-semibold select-none">Max Group Size</label>
                        <input type="number"
                               id="groupSizeMax"
                               name="groupSizeMax"
                               min="1"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                               placeholder="Max size" />
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="tourType" class="block mb-1 font-semibold select-none">Tour Type</label>
                        <input type="text"
                               id="tourType"
                               name="tourType"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                               placeholder="Enter tour type" />
                    </div>
                    <div>
                        <label for="status" class="block mb-1 font-semibold select-none">Status</label>
                        <select id="status"
                                name="status"
                                required
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="description" class="block mb-1 font-semibold select-none">Description</label>
                    <textarea id="description"
                              name="description"
                              rows="3"
                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                              placeholder="Enter tour description"></textarea>
                </div>
                <div>
                    <label for="policies" class="block mb-1 font-semibold select-none">Policies</label>
                    <textarea id="policies"
                              name="policies"
                              rows="3"
                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                              placeholder="Enter tour policies"></textarea>
                </div>
                <div>
                    <label for="featuredImageUrl" class="block mb-1 font-semibold select-none">Featured Image URL</label>
                    <input type="url"
                           id="featuredImageUrl"
                           name="featuredImageUrl"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                           placeholder="Enter image URL" />
                </div>
                <!-- Hidden Service Provider ID -->
                <input type="hidden" id="serviceProviderId" name="serviceProviderId" value="1" />
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button"
                            id="cancelBtn"
                            class="text-gray-700 text-xs font-semibold px-4 py-2 rounded-md hover:bg-gray-100">
                        Cancel
                    </button>
                    <button type="submit"
                            id="saveBtn"
                            class="bg-gray-900 text-white text-xs font-semibold px-4 py-2 rounded-md hover:bg-gray-800">
                        Add Tour
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Tour Modal -->
    <div id="editTourModal"
         class="fixed inset-0 flex items-center justify-center p-4 hidden z-40"
         role="dialog"
         aria-modal="true"
         aria-labelledby="editModalTitle">
        <div class="bg-white rounded-md shadow-lg max-w-md w-full p-6 relative">
            <h2 id="editModalTitle" class="text-lg font-semibold mb-4 select-none">
                Edit Tour
            </h2>
            <form id="editTourForm" class="space-y-4 text-xs text-gray-700">
                <div>
                    <label for="editTourCode" class="block mb-1 font-semibold select-none">Tour Code</label>
                    <input type="text"
                           id="editTourCode"
                           name="editTourCode"
                           required
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                           placeholder="Enter tour code" />
                </div>
                <div>
                    <label for="editTourName"
                           class="block mb-1 font-semibold select-none">Tour Name</label>
                    <input type="text"
                           id="editTourName"
                           name="editTourName"
                           required
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                           placeholder="Enter tour name" />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="editDepartureCity"
                               class="block mb-1 font-semibold select-none">Departure City</label>
                        <input type="text"
                               id="editDepartureCity"
                               name="editDepartureCity"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                               placeholder="Enter departure city" />
                    </div>
                    <div>
                        <label for="editDestination" class="block mb-1 font-semibold select-none">Destination</label>
                        <input type="text"
                               id="editDestination"
                               name="editDestination"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                               placeholder="Enter destination" />
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label for="editDuration" class="block mb-1 font-semibold select-none">Duration</label>
                        <input type="text"
                               id="editDuration"
                               name="editDuration"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                               placeholder="e.g. 3 days 2 nights" />
                    </div>
                    <div>
                        <label for="editGroupSizeMin" class="block mb-1 font-semibold select-none">Min Group Size</label>
                        <input type="number"
                               id="editGroupSizeMin"
                               name="editGroupSizeMin"
                               min="1"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                               placeholder="Min size" />
                    </div>
                    <div>
                        <label for="editGroupSizeMax" class="block mb-1 font-semibold select-none">Max Group Size</label>
                        <input type="number"
                               id="editGroupSizeMax"
                               name="editGroupSizeMax"
                               min="1"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                               placeholder="Max size" />
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="editTourType" class="block mb-1 font-semibold select-none">Tour Type</label>
                        <input type="text"
                               id="editTourType"
                               name="editTourType"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                               placeholder="Enter tour type" />
                    </div>
                    <div>
                        <label for="editStatus" class="block mb-1 font-semibold select-none">Status</label>
                        <select id="editStatus"
                                name="editStatus"
                                required
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="editDescription" class="block mb-1 font-semibold select-none">Description</label>
                    <textarea id="editDescription"
                              name="editDescription"
                              rows="3"
                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                              placeholder="Enter tour description"></textarea>
                </div>
                <div>
                    <label for="editPolicies" class="block mb-1 font-semibold select-none">Policies</label>
                    <textarea id="editPolicies"
                              name="editPolicies"
                              rows="3"
                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                              placeholder="Enter tour policies"></textarea>
                </div>
                <div>
                    <label for="editFeaturedImageUrl" class="block mb-1 font-semibold select-none">Featured Image URL</label>
                    <input type="url"
                           id="editFeaturedImageUrl"
                           name="editFeaturedImageUrl"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                           placeholder="Enter image URL" />
                </div>
                <!-- Hidden fields -->
                <input type="hidden" id="editServiceProviderId" name="editServiceProviderId" value="1" />
                <input type="hidden" id="editTourId" name="editTourId" />
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button"
                            id="editCancelBtn"
                            class="text-gray-700 text-xs font-semibold px-4 py-2 rounded-md hover:bg-gray-100">
                        Cancel
                    </button>
                    <button type="submit"
                            class="bg-gray-900 text-white text-xs font-semibold px-4 py-2 rounded-md hover:bg-gray-800">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Details Modal -->
    <div id="viewDetailsModal"
         class="fixed inset-0 flex items-center justify-center p-4 hidden z-40"
         role="dialog"
         aria-modal="true"
         aria-labelledby="viewDetailsTitle">
        <div class="bg-white rounded-md shadow-lg max-w-md w-full p-6 relative">
            <h2 id="viewDetailsTitle"
                class="text-lg font-semibold mb-4 select-none">
                Tour Details
            </h2>
            <div class="text-xs text-gray-700 space-y-3">
                <!-- Tour Image -->
                <div id="viewImageContainer" class="mb-4 hidden">
                    <img id="viewFeaturedImage" src="/placeholder.svg?height=200&width=400" alt="Tour image" class="w-full h-48 object-cover rounded-md" />
                </div>

                <div><strong>Tour Code:</strong> <span id="detailTourCode"></span></div>
                <div><strong>Name:</strong> <span id="detailTourName"></span></div>
                <div><strong>Departure City:</strong> <span id="detailDepartureCity"></span></div>
                <div><strong>Destination:</strong> <span id="detailDestination"></span></div>
                <div><strong>Duration:</strong> <span id="detailDuration"></span></div>
                <div><strong>Group Size:</strong> <span id="detailGroupSize"></span></div>
                <div><strong>Tour Type:</strong> <span id="detailTourType"></span></div>
                <div><strong>Description:</strong> <span id="detailDescription"></span></div>
                <div><strong>Policies:</strong> <span id="detailPolicies"></span></div>
                <div>
                    <strong>Status:</strong>
                    <span id="detailStatus"
                          class="inline-block px-2 py-0.5 rounded text-[10px] font-semibold"></span>
                </div>
            </div>
            <div class="flex justify-end space-x-3 pt-6">
                <button type="button"
                        id="viewCloseBtn"
                        class="text-gray-700 text-xs font-semibold px-4 py-2 rounded-md hover:bg-gray-100">
                    Close
                </button>
                <button type="button"
                        id="editFromViewBtn"
                        class="bg-gray-900 text-white text-xs font-semibold px-4 py-2 rounded-md hover:bg-gray-800">
                    Edit Tour
                </button>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_URL = '/api/TourApi';
        const tourTableBody = document.getElementById('tourTableBody');
        let currentEditTourId = null;
        let currentViewTourId = null;

        // Filter dropdown functionality
        const filterBtn = document.getElementById("filterBtn");
        const filterDropdown = document.getElementById("filterDropdown");

        filterBtn.addEventListener("click", () => {
            const isHidden = filterDropdown.classList.contains("hidden");
            if (isHidden) {
                filterDropdown.classList.remove("hidden");
                filterBtn.setAttribute("aria-expanded", "true");
            } else {
                filterDropdown.classList.add("hidden");
                filterBtn.setAttribute("aria-expanded", "false");
            }
        });

        // Close filter dropdown if clicked outside
        document.addEventListener("click", (e) => {
            if (
                !filterBtn.contains(e.target) &&
                !filterDropdown.contains(e.target)
            ) {
                filterDropdown.classList.add("hidden");
                filterBtn.setAttribute("aria-expanded", "false");
            }
        });

        // Filter rows by status
        filterDropdown.querySelectorAll("button").forEach((btn) => {
            btn.addEventListener("click", async () => {
                const status = btn.getAttribute("data-status");
                filterDropdown.classList.add("hidden");
                filterBtn.setAttribute("aria-expanded", "false");

                try {
                    let url = API_URL;
                    if (status !== "all") {
                        url = `${API_URL}/status/${status}`;
                    }

                    const res = await fetch(url);
                    if (!res.ok) {
                        throw new Error(`HTTP error! Status: ${res.status}`);
                    }

                    const data = await res.json();
                    console.log("Filter response:", data);

                    // Use the same extraction logic as fetchTours
                    const toursArray = extractToursArray(data);
                    renderTourTable(toursArray);
                } catch (err) {
                    console.error("Error filtering tours:", err);
                    document.getElementById("tourCount").textContent = `Error filtering tours: ${err.message}`;
                    renderTourTable([]);
                }
            });
        });

        function extractToursArray(data) {
            const idMap = new Map();

            function collectAllObjects(obj) {
                if (Array.isArray(obj)) {
                    obj.forEach(collectAllObjects);
                } else if (typeof obj === 'object' && obj !== null) {
                    if (obj.$id) {
                        idMap.set(obj.$id, obj);
                    }
                    Object.values(obj).forEach(collectAllObjects);
                }
            }

            // Dùng WeakSet để tránh đệ quy vô hạn
            const visited = new WeakSet();

            function resolveRefs(obj) {
                if (visited.has(obj)) return obj;
                if (obj && typeof obj === 'object') visited.add(obj);

                if (Array.isArray(obj)) {
                    return obj.map(resolveRefs);
                } else if (obj && obj.$ref) {
                    const refObj = idMap.get(obj.$ref);
                    return resolveRefs(refObj);
                } else if (typeof obj === 'object' && obj !== null) {
                    const newObj = {};
                    for (const key in obj) {
                        if (key !== '$id') {
                            newObj[key] = resolveRefs(obj[key]);
                        }
                    }
                    return newObj;
                } else {
                    return obj;
                }
            }

            // Bắt đầu xử lý
            collectAllObjects(data);
            const rawArray = data?.$values || [];
            const resolvedArray = resolveRefs(rawArray);
            return resolvedArray;
        }


        // API Testing Functions
        document.getElementById('testApiBtn').addEventListener('click', async () => {
            const resultDiv = document.getElementById('apiTestResult');
            resultDiv.textContent = "Testing API connection...";

            try {
                const res = await fetch(API_URL);
                const text = await res.text();

                resultDiv.textContent = `Response status: ${res.status}\n`;
                resultDiv.textContent += `Response headers: ${JSON.stringify([...res.headers.entries()])}\n`;
                resultDiv.textContent += `Response body:\n${text}`;

                try {
                    const data = JSON.parse(text);
                    resultDiv.textContent += `\n\nParsed JSON:\n${JSON.stringify(data, null, 2)}`;
                } catch (e) {
                    resultDiv.textContent += "\n\nCould not parse response as JSON";
                }
            } catch (err) {
                resultDiv.textContent = `Error: ${err.message}`;
            }
        });

        document.getElementById('testDbBtn').addEventListener('click', async () => {
            const resultDiv = document.getElementById('apiTestResult');
            resultDiv.textContent = "Testing database connection...";

            try {
                const response = await fetch(`${API_URL}/test-db`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                console.log("Database test:", data);
                resultDiv.textContent = `Database test result:\n${JSON.stringify(data, null, 2)}`;
            } catch (err) {
                console.error("Database test error:", err);
                resultDiv.textContent = `Database test error: ${err.message}`;
            }
        });

        // Fetch and display tours
        async function fetchTours() {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) {
                    throw new Error(`HTTP error! Status: ${res.status}`);
                }

                const data = await res.json();
                console.log("Fetched tours data type:", typeof data);
                console.log("Is array?", Array.isArray(data));
                console.log("Fetched tours:", data);

                // Use the helper function to extract tours array
                const toursArray = extractToursArray(data);
                console.log("Extracted tours array:", toursArray);

                renderTourTable(toursArray);

            } catch (err) {
                console.error('Error fetching tours:', err);
                document.getElementById("tourCount").textContent = `Error loading tours: ${err.message}`;
                renderTourTable([]); // Render empty table
            }
        }

        // Helper to safely display text (avoid showing N/A incorrectly)
        function safeText(value) {
            return value !== undefined && value !== null && value !== '' ? value : 'N/A';
        }

        function normalizeTour(tour) {
            if (!tour || !tour.TourId) return null;
            return {
                tourId: tour.TourId,
                tourCode: tour.TourCode,
                tourName: tour.TourName,
                departureCity: tour.DepartureCity,
                destination: tour.Destination,
                duration: tour.Duration,
                groupSizeMin: tour.GroupSizeMin,
                groupSizeMax: tour.GroupSizeMax,
                tourType: tour.TourType,
                description: tour.Description,
                status: tour.Status,
                policies: tour.Policies,
                featuredImageUrl: tour.FeaturedImageUrl,
                serviceProviderId: tour.ServiceProviderId
            };
        }


        function extractToursArray(data) {
            const idMap = new Map();

            function collectAllObjects(obj) {
                if (Array.isArray(obj)) {
                    obj.forEach(collectAllObjects);
                } else if (typeof obj === 'object' && obj !== null) {
                    if (obj.$id) {
                        idMap.set(obj.$id, obj);
                    }
                    Object.values(obj).forEach(collectAllObjects);
                }
            }

            const visited = new WeakSet();

            function resolveRefs(obj) {
                if (visited.has(obj)) return obj;
                if (obj && typeof obj === 'object') visited.add(obj);

                if (Array.isArray(obj)) {
                    return obj.map(resolveRefs);
                } else if (obj && obj.$ref) {
                    const refObj = idMap.get(obj.$ref);
                    return resolveRefs(refObj);
                } else if (typeof obj === 'object' && obj !== null) {
                    const newObj = {};
                    for (const key in obj) {
                        if (key !== '$id') {
                            newObj[key] = resolveRefs(obj[key]);
                        }
                    }
                    return newObj;
                } else {
                    return obj;
                }
            }

            collectAllObjects(data);
            const rawArray = data?.$values || [];
            return resolveRefs(rawArray);
        }

        async function fetchAndRenderTours() {
            try {
                const res = await fetch(API_URL);
                const json = await res.json();
                const tours = extractToursArray(json);
                renderTourTable(tours);
            } catch (err) {
                console.error('Error loading tours:', err);
            }
        }

        async function deleteTour(id) {
            try {
                const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    await fetchAndRenderTours();
                }
            } catch (err) {
                console.error('Delete failed', err);
            }
        }

        function renderTourTable(tours) {
            const tourTableBody = document.getElementById('tourTableBody');
            tourTableBody.innerHTML = '';

            if (!Array.isArray(tours) || tours.length === 0) {
                tourTableBody.innerHTML = `
        <tr>
          <td colspan="8" class="text-center py-4 text-gray-500">
            No tours found.
          </td>
        </tr>`;
                return;
            }

            document.getElementById("tourCount").textContent = `You have ${tours.length} tours in total`;

            tours.forEach(raw => {
                const tour = normalizeTour(raw);
                if (!tour) return;

                const tr = document.createElement('tr');
                tr.innerHTML = `
        <td class="border px-3 py-2">${safeText(tour.tourCode)}</td>
        <td class="border px-3 py-2">${safeText(tour.tourName)}</td>
        <td class="border px-3 py-2">${safeText(tour.departureCity)}</td>
        <td class="border px-3 py-2">${safeText(tour.destination)}</td>
        <td class="border px-3 py-2">${safeText(tour.duration)}</td>
        <td class="border px-3 py-2">
          <span class="inline-block px-2 py-0.5 rounded text-[10px] font-semibold ${tour.status === 'Active' ? 'bg-gray-900 text-white' : 'bg-gray-200 text-gray-700'
                    }">${safeText(tour.status)}</span>
        </td>
        <td class="border px-3 py-2">${safeText(tour.tourType)}</td>
        <td class="border px-3 py-2 text-center space-x-1">
          <button class="text-blue-600 hover:underline text-xs view-btn" data-id="${tour.tourId}">View</button>
          <button class="text-yellow-600 hover:underline text-xs edit-btn" data-id="${tour.tourId}">Edit</button>
          <button class="text-red-600 hover:underline text-xs delete-btn" data-id="${tour.tourId}">Delete</button>
        </td>`;
                tourTableBody.appendChild(tr);
            });

            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    const res = await fetch(`${API_URL}/${id}`);
                    const tour = await res.json();
                    openViewDetailsModal(tour);
                });
            });

            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    const res = await fetch(`${API_URL}/${id}`);
                    const tour = await res.json();
                    openEditModal(tour);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this tour?')) {
                        await deleteTour(id);
                    }
                });
            });
        }

        document.addEventListener("DOMContentLoaded", fetchAndRenderTours);

        // Close action menus when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.action-menu').forEach(m => m.classList.add('hidden'));
        });

        // Modal functionality
        const createTourModal = document.getElementById("createTourModal");
        const editTourModal = document.getElementById("editTourModal");
        const viewDetailsModal = document.getElementById("viewDetailsModal");
        const modalBackdrop = document.getElementById("modalBackdrop");
        const createTourBtn = document.getElementById("createTourBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const editCancelBtn = document.getElementById("editCancelBtn");
        const viewCloseBtn = document.getElementById("viewCloseBtn");
        const editFromViewBtn = document.getElementById("editFromViewBtn");
        const tourForm = document.getElementById("tourForm");
        const editTourForm = document.getElementById("editTourForm");
        const saveBtn = document.getElementById("saveBtn");

        // Open Create Tour Modal
        createTourBtn.addEventListener("click", () => {
            openCreateModal();
        });

        function openCreateModal() {
            currentEditTourId = null;
            saveBtn.textContent = "Create Tour";
            tourForm.reset();
            document.getElementById("serviceProviderId").value = 1; // Default service provider ID
            createTourModal.classList.remove("hidden");
            modalBackdrop.classList.remove("hidden");
            document.body.style.overflow = "hidden";
        }

        function openEditModal(rawTour) {
            const tour = normalizeTour(rawTour);
            if (!tour) return;

            document.getElementById('editTourId').value = tour.tourId || '';
            document.getElementById('editTourCode').value = tour.tourCode || '';
            document.getElementById('editTourName').value = tour.tourName || '';
            document.getElementById('editDepartureCity').value = tour.departureCity || '';
            document.getElementById('editDestination').value = tour.destination || '';
            document.getElementById('editDuration').value = tour.duration || '';
            document.getElementById('editGroupSizeMin').value = tour.groupSizeMin || '';
            document.getElementById('editGroupSizeMax').value = tour.groupSizeMax || '';
            document.getElementById('editTourType').value = tour.tourType || '';
            document.getElementById('editStatus').value = tour.status || 'Inactive';
            document.getElementById('editDescription').value = tour.description || '';
            document.getElementById('editPolicies').value = tour.policies || '';
            document.getElementById('editFeaturedImageUrl').value = tour.featuredImageUrl || '';
            document.getElementById('editServiceProviderId').value = tour.serviceProviderId || 1;

            // Hiện modal
            document.getElementById('editTourModal').classList.remove('hidden');
        }

        function openViewDetailsModal(rawTour) {
            const tour = normalizeTour(rawTour);
            if (!tour) return;

            // Text fields
            document.getElementById('detailTourCode').textContent = safeText(tour.tourCode);
            document.getElementById('detailTourName').textContent = safeText(tour.tourName);
            document.getElementById('detailDepartureCity').textContent = safeText(tour.departureCity);
            document.getElementById('detailDestination').textContent = safeText(tour.destination);
            document.getElementById('detailDuration').textContent = safeText(tour.duration);
            document.getElementById('detailGroupSize').textContent = (tour.groupSizeMin && tour.groupSizeMax)
                ? `${tour.groupSizeMin} - ${tour.groupSizeMax}`
                : 'Not specified';
            document.getElementById('detailTourType').textContent = safeText(tour.tourType);
            document.getElementById('detailDescription').textContent = safeText(tour.description);
            document.getElementById('detailPolicies').textContent = safeText(tour.policies);

            // Status badge
            const statusSpan = document.getElementById('detailStatus');
            statusSpan.textContent = safeText(tour.status);
            statusSpan.className = 'inline-block px-2 py-0.5 rounded text-[10px] font-semibold ' +
                (tour.status === 'Active' ? 'bg-gray-900 text-white' : 'bg-gray-200 text-gray-700');

            // Featured image
            const imageContainer = document.getElementById('viewImageContainer');
            const image = document.getElementById('viewFeaturedImage');
            if (tour.featuredImageUrl && tour.featuredImageUrl.trim() !== '') {
                image.src = tour.featuredImageUrl;
                imageContainer.classList.remove('hidden');
            } else {
                imageContainer.classList.add('hidden');
            }

            // Gắn tour hiện tại vào nút “Edit Tour”
            document.getElementById('editFromViewBtn').onclick = () => {
                document.getElementById('viewDetailsModal').classList.add('hidden');
                openEditModal(tour);
            };

            // Mở modal
            document.getElementById('viewDetailsModal').classList.remove('hidden');
        }

        // Gắn tour hiện tại vào nút “Edit Tour” trong modal View
        document.getElementById('editFromViewBtn').onclick = () => {
            document.getElementById('viewDetailsModal').classList.add('hidden'); // đóng view
            openEditModal(tour); // mở edit với cùng dữ liệu
        };

        function hideCreateModal() {
            createTourModal.classList.add("hidden");
            modalBackdrop.classList.add("hidden");
            document.body.style.overflow = "";
            tourForm.reset();
        }

        function hideEditModal() {
            editTourModal.classList.add("hidden");
            modalBackdrop.classList.add("hidden");
            document.body.style.overflow = "";
            editTourForm.reset();
            currentEditTourId = null;
        }

        function hideViewDetailsModal() {
            viewDetailsModal.classList.add("hidden");
            modalBackdrop.classList.add("hidden");
            document.body.style.overflow = "";
            currentViewTourId = null;
        }

        // Event listeners for modal close buttons
        cancelBtn.addEventListener("click", hideCreateModal);
        editCancelBtn.addEventListener("click", hideEditModal);
        viewCloseBtn.addEventListener("click", hideViewDetailsModal);

        // Edit from view button
        editFromViewBtn.addEventListener("click", async () => {
            hideViewDetailsModal();

            try {
                const res = await fetch(`${API_URL}/${currentViewTourId}`);
                if (!res.ok) {
                    throw new Error(`HTTP error! Status: ${res.status}`);
                }

                const tour = await res.json();
                openEditModal(tour);
            } catch (err) {
                console.error("Error fetching tour for edit:", err);
                alert("Could not load tour details for editing.");
            }
        });

        // Clicking backdrop hides any modal
        modalBackdrop.addEventListener("click", () => {
            if (!createTourModal.classList.contains("hidden")) hideCreateModal();
            if (!editTourModal.classList.contains("hidden")) hideEditModal();
            if (!viewDetailsModal.classList.contains("hidden")) hideViewDetailsModal();
        });

        // Create tour form submission
        tourForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const payload = {};

            formData.forEach((value, key) => {
                if (key === 'groupSizeMin' || key === 'groupSizeMax' || key === 'serviceProviderId') {
                    payload[key] = value ? parseInt(value) : null;
                } else {
                    payload[key] = value || null;
                }
            });

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert('Tour created successfully!');
                    hideCreateModal();
                    fetchTours();
                } else {
                    const errorData = await response.json();
                    alert(`Failed to create tour: ${errorData.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Create failed:', error);
                alert('Error creating tour: ' + error.message);
            }
        });

        // Edit tour form submission
        document.getElementById("editTourForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const tourId = document.getElementById("editTourId").value;
            const providerId = parseInt(document.getElementById("editServiceProviderId").value);

            const tour = {
                tourId: parseInt(tourId),
                tourCode: document.getElementById("editTourCode").value.trim(),
                tourName: document.getElementById("editTourName").value.trim(),
                departureCity: document.getElementById("editDepartureCity").value.trim(),
                destination: document.getElementById("editDestination").value.trim(),
                duration: document.getElementById("editDuration").value.trim(),
                groupSizeMin: parseInt(document.getElementById("editGroupSizeMin").value) || 0,
                groupSizeMax: parseInt(document.getElementById("editGroupSizeMax").value) || 0,
                tourType: document.getElementById("editTourType").value.trim(),
                description: document.getElementById("editDescription").value.trim(),
                policies: document.getElementById("editPolicies").value.trim(),
                status: document.getElementById("editStatus").value,
                featuredImageUrl: document.getElementById("editFeaturedImageUrl").value.trim() || null,
                serviceProviderId: providerId,
                serviceProvider: {
                    providerId: providerId,
                    name: "Hanoi Travel Services",
                    email: "contact@hanoitravel.com",
                    status: "Active",
                    providerType: "Premium"
                }
            };

            try {
                const res = await fetch(`${API_URL}/${tour.tourId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(tour)
                });

                if (res.ok) {
                    document.getElementById("editTourModal").classList.add("hidden");
                    fetchAndRenderTours();
                } else {
                    const errorMsg = await res.text();
                    alert("Update failed: " + errorMsg);
                }
            } catch (err) {
                alert("Unexpected error: " + err.message);
            }
        });

        // Delete tour function
        async function deleteTour(tourId) {
            try {
                const response = await fetch(`${API_URL}/${tourId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Tour deleted successfully!');
                    fetchTours();
                } else {
                    const errorData = await response.json();
                    alert(`Failed to delete tour: ${errorData.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Delete failed:', error);
                alert('Error deleting tour: ' + error.message);
            }
        }

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const keyword = searchInput.value.trim().toLowerCase();

                if (keyword === '') {
                    fetchTours();
                    return;
                }

                const rows = tourTableBody.querySelectorAll('tr');

                rows.forEach(row => {
                    const cells = row.children;
                    const tourCode = cells[0].textContent.toLowerCase();
                    const tourName = cells[1].textContent.toLowerCase();
                    const departureCity = cells[2].textContent.toLowerCase();
                    const destination = cells[3].textContent.toLowerCase();

                    if (tourCode.includes(keyword) ||
                        tourName.includes(keyword) ||
                        departureCity.includes(keyword) ||
                        destination.includes(keyword)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
        });

        // Mobile menu toggle
        const mobileMenuButton = document.getElementById("mobile-menu-button");
        const mobileDropdown = document.getElementById("mobile-dropdown");

        mobileMenuButton.addEventListener("click", () => {
            const expanded =
                mobileMenuButton.getAttribute("aria-expanded") === "true";
            mobileMenuButton.setAttribute("aria-expanded", !expanded);
            mobileDropdown.classList.toggle("hidden");
        });

        // Load tours when page loads
        window.onload = fetchTours;
    </script>
</body>
</html>