<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Traveloka Vouchers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
          rel="stylesheet" />
    <style>
        body {
            font-family: "Inter", sans-serif;
        }
    </style>
</head>
<body class="bg-white text-gray-900">
    <!-- Top Navigation -->
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-6">
                    <a class="flex items-center space-x-2 cursor-pointer"
                       id="logo-button"
                       role="button"
                       tabindex="0"
                       aria-label="Toggle mobile menu"
                       href="/Home">
                        <!-- Logo Image -->
                        <img src="/images/logo.png" alt="VieGo Logo" style="height: 120px; width: 120px;" />

                    </a>
                    <ul class="hidden md:flex space-x-6 text-sm font-normal text-[#1a1a1a]">
                        <li>
                            <a class="hover:underline" href="aboutus.html"> About Us </a>
                        </li>
                        <li>
                            <a class="hover:underline" href="faq.html"> FAQs </a>
                        </li>
                        <li>
                            <a class="hover:underline" href="blog.html"> Blog </a>
                        </li>
                        <li>
                            <a class="hover:underline" href="/MyBooking">
                                My Bookings
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
    </header>

    <main class="flex min-h-[calc(100vh-56px)]">
        <!-- Sidebar -->
        <aside class="w-56 border-r border-gray-200 px-4 py-6 text-sm font-semibold text-gray-900 select-none overflow-y-auto">
            <h2 class="mb-4">Service Provider</h2>
            <nav class="flex flex-col space-y-2 text-gray-700 font-normal">
                <a class="flex items-center space-x-2 hover:text-gray-900 transition-colors duration-200"
                   href="serviceproviderdashboard.html"><i class="fas fa-list-alt text-xs"></i><span>Dashboard</span></a>
                <a class="flex items-center space-x-2 hover:text-gray-900 transition-colors duration-200"
                   href="serviceprovidermanagetour.html"><i class="fas fa-list-alt text-xs"></i><span>Manage Tours</span></a>
                <a class="flex items-center space-x-2 hover:text-gray-900 transition-colors duration-200"
                   href="serviceProvidermanagevoucher.html">
                    <i class="fas fa-ticket-alt text-xs"></i><span>Manage Vouchers</span>
                </a>
                <a class="flex items-center space-x-2 hover:text-gray-900 transition-colors duration-200"
                   href="serviceProvidervoucherusage.html">
                    <i class="fas fa-chart-pie text-xs"></i><span>Voucher Usage</span>
                </a>
                <a class="flex items-center space-x-2 hover:text-gray-900 transition-colors duration-200"
                   href="serviceprovidermanagebookings.html">
                    <i class="fas fa-calendar-check text-xs"></i><span>Manage Bookings</span>
                </a>
                <a class="flex items-center space-x-2 hover:text-gray-900 transition-colors duration-200"
                   href="#">
                    <i class="fas fa-comment-alt text-xs"></i><span>Customer Reviews</span>
                </a>
                <a class="flex items-center space-x-2 hover:text-gray-900 transition-colors duration-200"
                   href="#">
                    <i class="far fa-star text-xs"></i><span>Rating Statistics</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <section class="flex-1 p-6">
            <h1 class="text-lg font-extrabold mb-1 select-none">Vouchers</h1>
            <p class="text-sm text-gray-500 mb-6 select-none">
                Create and manage discount vouchers for your tours
            </p>

            <div class="bg-white border border-gray-200 rounded-md p-6">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                    <div>
                        <h2 class="font-semibold text-base select-none">Your Vouchers</h2>
                        <p id="voucherCount" class="text-xs text-gray-500 select-none">
                            You have 0 vouchers in total
                        </p>

                    </div>
                    <button id="createVoucherBtn"
                            class="mt-3 sm:mt-0 inline-flex items-center space-x-2 bg-gray-900 text-white text-xs font-semibold px-4 py-2 rounded-md hover:bg-gray-800"
                            type="button">
                        <i class="fas fa-plus text-[10px]"></i>
                        <span>Create Voucher</span>
                    </button>
                </div>

                <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-2 mb-4 relative">
                    <input type="text"
                           id="searchInput"
                           placeholder="Search vouchers..."
                           class="flex-1 border border-gray-300 rounded-md px-3 py-2 text-xs text-gray-700 focus:outline-none focus:ring-1 focus:ring-gray-400" />
                    <div class="relative mt-2 sm:mt-0">
                        <button id="filterBtn"
                                aria-haspopup="true"
                                aria-expanded="false"
                                class="flex items-center space-x-1 border border-gray-300 rounded-md px-3 py-2 text-xs text-gray-700 hover:bg-gray-100 focus:outline-none"
                                type="button">
                            <span>Filter</span>
                            <i class="fas fa-sort text-[10px]"></i>
                        </button>
                        <!-- Dropdown -->
                        <div id="filterDropdown"
                             class="hidden absolute right-0 mt-1 w-32 bg-white border border-gray-300 rounded-md shadow-lg z-10"
                             role="menu"
                             aria-label="Filter vouchers by status">
                            <button class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-100 focus:bg-gray-100 focus:outline-none"
                                    type="button"
                                    data-status="all">
                                All
                            </button>
                            <button class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-100 focus:bg-gray-100 focus:outline-none"
                                    type="button"
                                    data-status="active">
                                Active
                            </button>
                            <button class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-100 focus:bg-gray-100 focus:outline-none"
                                    type="button"
                                    data-status="inactive">
                                Inactive
                            </button>
                            <button class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-100 focus:bg-gray-100 focus:outline-none"
                                    type="button"
                                    data-status="expired">
                                Expired
                            </button>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto overflow-visible relative">

                    <table class="w-full text-xs text-left text-gray-700 border-collapse border border-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="border border-gray-200 px-3 py-2 font-normal">
                                    Code
                                </th>
                                <th class="border border-gray-200 px-3 py-2 font-normal">
                                    Description
                                </th>
                                <th class="border border-gray-200 px-3 py-2 font-normal">
                                    Discount
                                </th>
                                <th class="border border-gray-200 px-3 py-2 font-normal">
                                    Valid Period
                                </th>
                                <th class="border border-gray-200 px-3 py-2 font-normal">
                                    Quantity
                                </th>
                                <th class="border border-gray-200 px-3 py-2 font-normal">
                                    Status
                                </th>
                                <th class="border border-gray-200 px-3 py-2 font-normal">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="voucherTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal backdrop -->
    <div id="modalBackdrop"
         class="fixed inset-0 bg-black bg-opacity-30 hidden z-30"
         aria-hidden="true"></div>

    <!-- Create Voucher Modal -->
    <div id="createVoucherModal"
         class="fixed inset-0 flex items-center justify-center p-4 hidden z-40"
         role="dialog"
         aria-modal="true"
         aria-labelledby="modalTitle">
        <div class="bg-white rounded-md shadow-lg max-w-md w-full p-6 relative">
            <h2 id="modalTitle" class="text-lg font-semibold mb-4 select-none">
                Create Voucher
            </h2>
            <form id="voucherForm" class="space-y-4 text-xs text-gray-700">
                <div>
                    <label for="code" class="block mb-1 font-semibold select-none">Code</label>
                    <input type="text"
                           id="code"
                           name="code"
                           required
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                           placeholder="Enter voucher code" />
                </div>
                <div>
                    <label for="description"
                           class="block mb-1 font-semibold select-none">Description</label>
                    <input type="text"
                           id="description"
                           name="description"
                           required
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                           placeholder="Enter description" />
                </div>
                <div>
                    <label for="discount" class="block mb-1 font-semibold select-none">Discount</label>
                    <input type="text"
                           id="discount"
                           name="discount"
                           required
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                           placeholder="e.g. 15% or $50" />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="startDate"
                               class="block mb-1 font-semibold select-none">Start Date</label>
                        <input type="date"
                               id="startDate"
                               name="startDate"
                               required
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400" />
                    </div>
                    <div>
                        <label for="endDate" class="block mb-1 font-semibold select-none">End Date</label>
                        <input type="date"
                               id="endDate"
                               name="endDate"
                               required
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400" />
                    </div>
                </div>
                <div>
                    <label for="quantity" class="block mb-1 font-semibold select-none">Quantity</label>
                    <input type="number"
                           id="quantity"
                           name="quantity"
                           min="1"
                           required
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                           placeholder="Enter quantity" />
                </div>
                <div>
                    <label for="status" class="block mb-1 font-semibold select-none">Status</label>
                    <select id="status"
                            name="status"
                            required
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="expired">Expired</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button"
                            id="cancelBtn"
                            class="text-gray-700 text-xs font-semibold px-4 py-2 rounded-md hover:bg-gray-100">
                        Cancel
                    </button>
                    <button type="submit"
                            class="bg-gray-900 text-white text-xs font-semibold px-4 py-2 rounded-md hover:bg-gray-800">
                        Add Voucher
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Voucher Modal -->
    <div id="editVoucherModal"
         class="fixed inset-0 flex items-center justify-center p-4 hidden z-40"
         role="dialog"
         aria-modal="true"
         aria-labelledby="editModalTitle">
        <div class="bg-white rounded-md shadow-lg max-w-md w-full p-6 relative">
            <h2 id="editModalTitle" class="text-lg font-semibold mb-4 select-none">
                Edit Voucher
            </h2>
            <form id="editVoucherForm" class="space-y-4 text-xs text-gray-700">
                <div>
                    <label for="editCode" class="block mb-1 font-semibold select-none">Code</label>
                    <input type="text"
                           id="editCode"
                           name="editCode"
                           required
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                           placeholder="Enter voucher code" />
                </div>
                <div>
                    <label for="editDescription"
                           class="block mb-1 font-semibold select-none">Description</label>
                    <input type="text"
                           id="editDescription"
                           name="editDescription"
                           required
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                           placeholder="Enter description" />
                </div>
                <div>
                    <label for="editDiscount"
                           class="block mb-1 font-semibold select-none">Discount</label>
                    <input type="text"
                           id="editDiscount"
                           name="editDiscount"
                           required
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                           placeholder="e.g. 15% or $50" />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="editStartDate"
                               class="block mb-1 font-semibold select-none">Start Date</label>
                        <input type="date"
                               id="editStartDate"
                               name="editStartDate"
                               required
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400" />
                    </div>
                    <div>
                        <label for="editEndDate"
                               class="block mb-1 font-semibold select-none">End Date</label>
                        <input type="date"
                               id="editEndDate"
                               name="editEndDate"
                               required
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400" />
                    </div>
                </div>
                <div>
                    <label for="editQuantity"
                           class="block mb-1 font-semibold select-none">Quantity</label>
                    <input type="number"
                           id="editQuantity"
                           name="editQuantity"
                           min="1"
                           required
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400"
                           placeholder="Enter quantity" />
                </div>
                <div>
                    <label for="editStatus" class="block mb-1 font-semibold select-none">Status</label>
                    <select id="editStatus"
                            name="editStatus"
                            required
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-400">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="expired">Expired</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button"
                            id="editCancelBtn"
                            class="text-gray-700 text-xs font-semibold px-4 py-2 rounded-md hover:bg-gray-100">
                        Cancel
                    </button>
                    <button type="submit"
                            class="bg-gray-900 text-white text-xs font-semibold px-4 py-2 rounded-md hover:bg-gray-800">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Details Modal -->
    <div id="viewDetailsModal"
         class="fixed inset-0 flex items-center justify-center p-4 hidden z-40"
         role="dialog"
         aria-modal="true"
         aria-labelledby="viewDetailsTitle">
        <div class="bg-white rounded-md shadow-lg max-w-md w-full p-6 relative">
            <h2 id="viewDetailsTitle"
                class="text-lg font-semibold mb-4 select-none">
                Voucher Details
            </h2>
            <div class="text-xs text-gray-700 space-y-3">
                <div><strong>Code:</strong> <span id="detailCode"></span></div>
                <div>
                    <strong>Description:</strong> <span id="detailDescription"></span>
                </div>
                <div>
                    <strong>Discount:</strong> <span id="detailDiscount"></span>
                </div>
                <div>
                    <strong>Valid Period:</strong> <span id="detailValidPeriod"></span>
                </div>
                <div>
                    <strong>Quantity:</strong> <span id="detailQuantity"></span>
                </div>
                <div>
                    <strong>Status:</strong>
                    <span id="detailStatus"
                          class="inline-block px-2 py-0.5 rounded text-[10px] font-semibold"></span>
                </div>
            </div>
            <div class="flex justify-end pt-6">
                <button id="viewCloseBtn"
                        class="bg-gray-900 text-white text-xs font-semibold px-4 py-2 rounded-md hover:bg-gray-800"
                        type="button">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentEditVoucherId = null;

        const filterBtn = document.getElementById("filterBtn");
        const filterDropdown = document.getElementById("filterDropdown");
        //const voucherTableBody = document.getElementById("voucherTableBody");

        filterBtn.addEventListener("click", () => {
            const isHidden = filterDropdown.classList.contains("hidden");
            if (isHidden) {
                filterDropdown.classList.remove("hidden");
                filterBtn.setAttribute("aria-expanded", "true");
            } else {
                filterDropdown.classList.add("hidden");
                filterBtn.setAttribute("aria-expanded", "false");
            }
        });

        // Close filter dropdown if clicked outside
        document.addEventListener("click", (e) => {
            if (
                !filterBtn.contains(e.target) &&
                !filterDropdown.contains(e.target)
            ) {
                filterDropdown.classList.add("hidden");
                filterBtn.setAttribute("aria-expanded", "false");
            }
        });

        // Filter rows by status
        filterDropdown.querySelectorAll("button").forEach((btn) => {
            btn.addEventListener("click", async () => {
                const status = btn.getAttribute("data-status");
                filterDropdown.classList.add("hidden");
                filterBtn.setAttribute("aria-expanded", "false");

                try {
                    let url = API_URL;
                    if (status !== "all") {
                        const formattedStatus = status.charAt(0).toUpperCase() + status.slice(1);
                        url = `${API_URL}/status/${formattedStatus}`;
                    }

                    const res = await fetch(url);
                    const data = await res.json();
                    renderVoucherTable(data);
                } catch (err) {
                    console.error("Error filtering vouchers:", err);
                }
            });
        });

        // Action menu toggle
        document.querySelectorAll(".action-cell").forEach((cell) => {
            const dots = cell.querySelector(".action-dots");
            const menu = cell.querySelector(".action-menu");

            dots.addEventListener("click", (e) => {
                e.stopPropagation();
                // Close other open menus
                document.querySelectorAll(".action-menu").forEach((m) => {
                    if (m !== menu) m.classList.add("hidden");
                });
                menu.classList.toggle("hidden");
            });
        });

        // Close action menus if clicked outside
        document.addEventListener("click", () => {
            document.querySelectorAll(".action-menu").forEach((menu) => {
                menu.classList.add("hidden");
            });
        });

        // Modal elements for create
        const createVoucherBtn = document.getElementById("createVoucherBtn");
        const createVoucherModal = document.getElementById("createVoucherModal");
        const modalBackdrop = document.getElementById("modalBackdrop");
        const cancelBtn = document.getElementById("cancelBtn");
        const voucherForm = document.getElementById("voucherForm");

        // Modal elements for edit
        const editVoucherModal = document.getElementById("editVoucherModal");
        const editVoucherForm = document.getElementById("editVoucherForm");
        const editCancelBtn = document.getElementById("editCancelBtn");

        // Modal elements for view details
        const viewDetailsModal = document.getElementById("viewDetailsModal");
        const viewCloseBtn = document.getElementById("viewCloseBtn");
        const detailCode = document.getElementById("detailCode");
        const detailDescription = document.getElementById("detailDescription");
        const detailDiscount = document.getElementById("detailDiscount");
        const detailValidPeriod = document.getElementById("detailValidPeriod");
        const detailQuantity = document.getElementById("detailQuantity");
        const detailStatus = document.getElementById("detailStatus");

        // Show create modal
        createVoucherBtn.addEventListener("click", () => {
            createVoucherModal.classList.remove("hidden");
            modalBackdrop.classList.remove("hidden");
            document.body.style.overflow = "hidden";
        });

        // Hide create modal
        function hideCreateModal() {
            createVoucherModal.classList.add("hidden");
            modalBackdrop.classList.add("hidden");
            document.body.style.overflow = "";
            voucherForm.reset();
        }

        // Hide edit modal
        function hideEditModal() {
            editVoucherModal.classList.add("hidden");
            modalBackdrop.classList.add("hidden");
            document.body.style.overflow = "";
            editVoucherForm.reset();
            currentEditRow = null;
        }

        // Hide view details modal
        function hideViewDetailsModal() {
            viewDetailsModal.classList.add("hidden");
            modalBackdrop.classList.add("hidden");
            document.body.style.overflow = "";
            clearViewDetails();
        }

        // Cancel buttons hide modals
        cancelBtn.addEventListener("click", hideCreateModal);
        editCancelBtn.addEventListener("click", hideEditModal);
        viewCloseBtn.addEventListener("click", hideViewDetailsModal);

        // Clicking backdrop hides any modal
        modalBackdrop.addEventListener("click", () => {
            if (!createVoucherModal.classList.contains("hidden")) hideCreateModal();
            if (!editVoucherModal.classList.contains("hidden")) hideEditModal();
            if (!viewDetailsModal.classList.contains("hidden"))
                hideViewDetailsModal();
        });

        // Handle create form submission


        // Edit modal logic
        let currentEditRow = null;

        function openEditModal(row) {
            currentEditRow = row;
            const cells = row.querySelectorAll("td");

            // Extract data from row
            const code = cells[0].textContent.trim();
            const description = cells[1].textContent.trim();
            const discount = cells[2].textContent.trim();
            const validPeriod = cells[3].textContent.trim();
            const quantity = cells[4].textContent.trim();
            const statusText = cells[5].textContent.trim().toLowerCase();

            // Parse valid period into start and end dates
            const [startDateStr, endDateStr] = validPeriod.split(" - ");
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);

            // Fill form fields
            editVoucherForm.editCode.value = code;
            editVoucherForm.editDescription.value = description;
            editVoucherForm.editDiscount.value = discount;
            editVoucherForm.editStartDate.value = startDate
                .toISOString()
                .slice(0, 10);
            editVoucherForm.editEndDate.value = endDate.toISOString().slice(0, 10);
            editVoucherForm.editQuantity.value = quantity;
            editVoucherForm.editStatus.value = statusText;

            // Show modal and backdrop
            editVoucherModal.classList.remove("hidden");
            modalBackdrop.classList.remove("hidden");
            document.body.style.overflow = "hidden";
        }

        // Handle edit form submission
        editVoucherForm.addEventListener("submit", (e) => {
            e.preventDefault();
            if (!currentEditRow) return;

            // Get form values
            const code = editVoucherForm.editCode.value.trim();
            const description = editVoucherForm.editDescription.value.trim();
            const discount = editVoucherForm.editDiscount.value.trim();
            const startDate = editVoucherForm.editStartDate.value;
            const endDate = editVoucherForm.editEndDate.value;
            const quantity = editVoucherForm.editQuantity.value.trim();
            const status = editVoucherForm.editStatus.value;

            // Format valid period string
            const options = { year: "numeric", month: "short", day: "numeric" };
            const startDateFormatted = new Date(startDate).toLocaleDateString(
                "en-US",
                options
            );
            const endDateFormatted = new Date(endDate).toLocaleDateString(
                "en-US",
                options
            );
            const validPeriod = `${startDateFormatted} - ${endDateFormatted}`;

            // Status badge color
            let statusBadgeClasses =
                "inline-block text-[10px] font-semibold px-2 py-0.5 rounded select-none ";
            if (status === "active") {
                statusBadgeClasses += "bg-gray-900 text-white";
            } else if (status === "expired") {
                statusBadgeClasses += "bg-gray-300 text-gray-600";
            } else {
                statusBadgeClasses += "bg-gray-200 text-gray-700";
            }

            // Update row data
            const cells = currentEditRow.querySelectorAll("td");
            cells[0].textContent = code;
            cells[1].textContent = description;
            cells[2].textContent = discount;
            cells[3].textContent = validPeriod;
            cells[4].textContent = quantity;
            cells[5].innerHTML = `<span class="${statusBadgeClasses}">${status.charAt(0).toUpperCase() + status.slice(1)
                }</span>`;
            currentEditRow.setAttribute("data-status", status);

            // Hide edit modal
            hideEditModal();
        });

        // Add event listeners for existing edit buttons
        document.querySelectorAll(".edit-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const row = e.target.closest("tr");
                openEditModal(row);
            });
        });

        // View details modal logic
        function clearViewDetails() {
            detailCode.textContent = "";
            detailDescription.textContent = "";
            detailDiscount.textContent = "";
            detailValidPeriod.textContent = "";
            detailQuantity.textContent = "";
            detailStatus.textContent = "";
            detailStatus.className =
                "inline-block px-2 py-0.5 rounded text-[10px] font-semibold";
        }

        //function openViewDetailsModal(row) {
        //    const cells = row.querySelectorAll("td");

        //    detailCode.textContent = cells[0].textContent.trim();
        //    detailDescription.textContent = cells[1].textContent.trim();
        //    detailDiscount.textContent = cells[2].textContent.trim();
        //    detailValidPeriod.textContent = cells[3].textContent.trim();
        //    detailQuantity.textContent = cells[4].textContent.trim();

        //    const statusSpan = cells[5].querySelector("span");
        //    detailStatus.textContent = statusSpan.textContent.trim();
        //    detailStatus.className = statusSpan.className;

        //    viewDetailsModal.classList.remove("hidden");
        //    modalBackdrop.classList.remove("hidden");
        //    document.body.style.overflow = "hidden";
        //}

        function openViewDetailsModal(voucher) {
    detailCode.textContent = voucher.code;
    detailDescription.textContent = voucher.description;
    detailDiscount.textContent = voucher.discountValue + "%";
    detailValidPeriod.textContent =
        formatDate(voucher.validFrom) + " - " + formatDate(voucher.validUntil);
    detailQuantity.textContent = voucher.quantity;

    // Set status badge
    detailStatus.textContent = voucher.status;
    detailStatus.className =
        "inline-block px-2 py-0.5 rounded text-[10px] font-semibold";

    if (voucher.status === "Active") {
        detailStatus.classList.add("bg-gray-900", "text-white");
    } else if (voucher.status === "Expired") {
        detailStatus.classList.add("bg-gray-300", "text-gray-600");
    } else {
        detailStatus.classList.add("bg-gray-200", "text-gray-700");
    }

    // Show modal
    viewDetailsModal.classList.remove("hidden");
    modalBackdrop.classList.remove("hidden");
    document.body.style.overflow = "hidden";
}


        // Add event listeners for existing view buttons
        document.querySelectorAll(".view-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const row = e.target.closest("tr");
                openViewDetailsModal(row);
            });
        });
    </script>

    <!--//List-->
    <script>
        const API_URL = '/api/DiscountCodeApi';
        const voucherTableBody = document.getElementById('voucherTableBody');

        async function fetchVouchers() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                console.log("Fetched vouchers:", data);
                renderVoucherTable(data);
            } catch (err) {
                console.error('Error fetching vouchers:', err);
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-GB'); // dd/mm/yyyy
        }

        function renderVoucherTable(vouchers) {
            voucherTableBody.innerHTML = '';
            document.getElementById("voucherCount").textContent = `You have ${vouchers.length} vouchers in total`;


            vouchers.forEach(v => {
                const tr = document.createElement('tr');
                tr.className = 'border-t border-gray-200';
                tr.innerHTML = `
                  <td class="border px-3 py-2">${v.code}</td>
                  <td class="border px-3 py-2">${v.description}</td>
                  <td class="border px-3 py-2">${v.discountValue}%</td>
                  <td class="border px-3 py-2">${formatDate(v.validFrom)} - ${formatDate(v.validUntil)}</td>
                  <td class="border px-3 py-2">${v.quantity}</td>
                  <td class="border px-3 py-2">${v.status}</td>
                  <td class="border px-3 py-2 text-center relative action-cell">
                    <span class="action-dots cursor-pointer">...</span>
                    <div class="absolute right-0 top-full mt-1 w-32 bg-white border border-gray-300 rounded-md shadow-lg z-50 hidden action-menu">
                      <button class="view-btn w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-100">View Details</button>
                      <button class="edit-btn w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-100">Edit</button>
                      <button class="delete-btn w-full text-left px-3 py-2 text-xs text-red-600 hover:bg-red-100">Delete</button>
                    </div>
                  </td>
                `;
                voucherTableBody.appendChild(tr);

                // Gắn sự kiện cho các nút trong menu
                const actionDots = tr.querySelector('.action-dots');
                const actionMenu = tr.querySelector('.action-menu');
                const deleteBtn = tr.querySelector('.delete-btn');

                actionDots.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.action-menu').forEach(m => m.classList.add('hidden'));
                    actionMenu.classList.toggle('hidden');
                });

                deleteBtn.addEventListener('click', async () => {
                    if (confirm("Are you sure to delete this voucher?")) {
                        await fetch(`${API_URL}/${v.discountCodeID}`, { method: 'DELETE' });
                        fetchVouchers();
                    }
                });

                // TODO: Add event for view-btn and edit-btn here if needed
                const editBtn = tr.querySelector('.edit-btn');
                editBtn.addEventListener('click', () => openEditModal(v));

                const viewBtn = tr.querySelector('.view-btn');
                viewBtn.addEventListener('click', () => openViewDetailsModal(v));


            });
        }

        // Đóng tất cả menu khi click ngoài
        document.addEventListener('click', () => {
            document.querySelectorAll('.action-menu').forEach(m => m.classList.add('hidden'));
        });


        async function deleteVoucher(id) {
            if (!confirm('Are you sure to delete this voucher?')) return;
            await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            fetchVouchers();
        }

        window.onload = fetchVouchers;
    </script>

    <!--Add new vpucher-->
    <script>
        //const API_URL = '/api/DiscountCodeApi';
        //const voucherForm = document.getElementById('voucherForm');

        voucherForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const payload = {};

            formData.forEach((value, key) => {
                if (key === 'discount') {
                    key = 'discountValue';
                    value = parseFloat(value.replace('%', '')); // "12%" → 12
                }
                if (key === 'status') {
                    value = value.charAt(0).toUpperCase() + value.slice(1); // active → Active
                }
                payload[key] = value;
            });


            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                hideCreateModal(); // đóng modal
                fetchVouchers();   // load lại danh sách từ DB
            } catch (error) {
                console.error('Create failed:', error);
            }
        });
    </script>

    <!--Edit vouchewr-->
    <script>
        function openEditModal(voucher) {
            currentEditVoucherId = voucher.discountCodeID;

            // Gán giá trị vào form
            editVoucherForm.editCode.value = voucher.code;
            editVoucherForm.editDescription.value = voucher.description;
            editVoucherForm.editDiscount.value = voucher.discountValue;
            editVoucherForm.editStartDate.value = voucher.validFrom?.slice(0, 10);
            editVoucherForm.editEndDate.value = voucher.validUntil?.slice(0, 10);
            editVoucherForm.editQuantity.value = voucher.quantity;
            editVoucherForm.editStatus.value = voucher.status.toLowerCase();

            // Hiện modal
            editVoucherModal.classList.remove("hidden");
            modalBackdrop.classList.remove("hidden");
            document.body.style.overflow = "hidden";
        }

    </script>
    <script>
        editVoucherForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            if (!currentEditVoucherId) return;

            const formData = new FormData(this);
            const payload = {};

            formData.forEach((value, key) => {
                if (key === "editDiscount") {
                    key = "discountValue";
                    value = parseFloat(value.replace('%', ''));
                }
                if (key === "editStatus") {
                    key = "status";
                    value = value.charAt(0).toUpperCase() + value.slice(1);
                }

                if (key.startsWith("edit")) {
                    key = key.replace("edit", "");
                    key = key.charAt(0).toLowerCase() + key.slice(1);
                }

                payload[key] = value;
            });

            try {
                await fetch(`${API_URL}/${currentEditVoucherId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                hideEditModal();  // đóng modal
                fetchVouchers();  // load lại danh sách
            } catch (err) {
                console.error("Update failed:", err);
            }
        });
    </script>
    <script>
        const searchInput = document.getElementById('searchInput');

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();

                const keyword = searchInput.value.trim().toLowerCase();

                const rows = voucherTableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const codeCell = row.children[0]; // cột chứa mã voucher
                    const code = codeCell.textContent.trim().toLowerCase();

                    if (code.includes(keyword)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
        });

    </script>
</body>
</html>
